@model Sales_Management.Models.Order

@{
	ViewData["Title"] = $"Chi tiết đơn hàng #{Model.OrderId}";
	Layout = "_SaleLayout";
}

<div class="d-flex align-items-center justify-content-between mb-4">
	<div class="d-flex align-items-center gap-3">
		<a asp-area="Sale" asp-controller="Products" asp-action="Index" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Quay lại</a>
		<h4 class="mb-0 fw-bold">Đơn hàng #@Model.OrderId</h4>
		@{
			var statusColor = Model.Status switch
			{
				"Completed" => "success",
				"Paid" => "success",
				"Confirmed" => "info",
				"Draft" => "secondary",
				"Cancelled" => "danger",
				_ => "light"
			};
		}
		<span class="badge bg-@statusColor">@Model.Status</span>
	</div>

	<div class="d-flex gap-2">
		@if (Model.Status == "Draft")
		{
			<form asp-area="Sale"
				  asp-controller="Orders"
				  asp-action="UpdateStatus"
				  method="post">
				@Html.AntiForgeryToken()
				<input type="hidden" name="id" value="@Model.OrderId" />
				<input type="hidden" name="newStatus" value="Confirmed" />
				<button type="submit" class="btn btn-primary"><i class="bi bi-check2-circle"></i> Xác nhận đơn</button>
			</form>
		}
		@if (Model.Status == "Confirmed")
		{
			<form asp-area="Sale"
				  asp-controller="Orders"
				  asp-action="UpdateStatus"
				  method="post">
				@Html.AntiForgeryToken()
				<input type="hidden" name="id" value="@Model.OrderId" />
				<input type="hidden" name="newStatus" value="Paid" />
				<button type="submit" class="btn btn-success"><i class="bi bi-credit-card"></i> Xác nhận thanh toán</button>
			</form>
		}
		@if (Model.Status == "Paid")
		{
			<form asp-area="Sale"
				  asp-controller="Orders"
				  asp-action="UpdateStatus"
				  method="post">
				@Html.AntiForgeryToken()
				<input type="hidden" name="id" value="@Model.OrderId" />
				<input type="hidden" name="newStatus" value="Completed" />
				<button type="submit" class="btn btn-success"><i class="bi bi-check-all"></i> Hoàn tất đơn hàng</button>
			</form>
		}
		@if (Model.Status != "Cancelled" && Model.Status != "Completed")
		{
			<form asp-area="Sale" asp-controller="Orders" asp-action="UpdateStatus" method="post" onsubmit="return confirm('Bạn có chắc muốn hủy đơn hàng này?');">
				@Html.AntiForgeryToken()
				<input type="hidden" name="id" value="@Model.OrderId" />
				<input type="hidden" name="newStatus" value="Cancelled" />
				<button type="submit" class="btn btn-outline-danger"><i class="bi bi-x-circle"></i> Hủy đơn</button>
			</form>
		}
	</div>
</div>

<div class="row g-4">
	<div class="col-lg-8">
		<div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
			<div class="card-header bg-white border-0 py-3">
				<h6 class="fw-bold mb-0">Danh sách sản phẩm</h6>
			</div>
			<div class="card-body p-0">
				<table class="table align-middle">
					<thead class="bg-light">
						<tr>
							<th class="ps-4">Sản phẩm</th>
							<th class="text-center">Số lượng</th>
							<th class="text-end">Đơn giá</th>
							<th class="text-end pe-4">Thành tiền</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var item in Model.OrderDetails)
						{
							<tr>
								<td class="ps-4">
									<div class="d-flex align-items-center">
										<img src="@(item.Product.ProductImages.FirstOrDefault(i => i.IsPrimary == true)?.ImageUrl ?? "https://placehold.co/50")"
											 class="rounded me-3 border" style="width: 50px; height: 50px; object-fit: cover;" onerror="this.src='https://placehold.co/50'" />
										<div>
											<h6 class="mb-0">@item.Product.Name</h6>
											<small class="text-muted">Mã: @item.Product.Code</small>
										</div>
									</div>
								</td>
								<td class="text-center">@item.Quantity</td>
								<td class="text-end">@item.UnitPrice.ToString("N0") ₫</td>
								<td class="text-end pe-4 fw-bold">@item.Total?.ToString("N0") ₫</td>
							</tr>
						}
					</tbody>
					<tfoot class="border-top">
						<tr>
							<td colspan="3" class="text-end pt-3">Tạm tính:</td>
							<td class="text-end pe-4 pt-3">@Model.SubTotal?.ToString("N0") ₫</td>
						</tr>
						<tr>
							<td colspan="3" class="text-end border-0">Thuế (VAT):</td>
							<td class="text-end pe-4 border-0">@Model.TaxAmount?.ToString("N0") ₫</td>
						</tr>
						<tr>
							<td colspan="3" class="text-end border-0">Giảm giá:</td>
							<td class="text-end pe-4 border-0 text-danger">-@Model.DiscountAmount?.ToString("N0") ₫</td>
						</tr>
						<tr>
							<td colspan="3" class="text-end border-0 pb-3"><h5 class="fw-bold mb-0">Tổng cộng:</h5></td>
							<td class="text-end pe-4 border-0 pb-3"><h5 class="fw-bold text-primary mb-0">@Model.TotalAmount?.ToString("N0") ₫</h5></td>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>
	</div>

	<div class="col-lg-4">
		<!-- Customer Info -->
		<div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
			<div class="card-header bg-white border-0 py-3">
				<h6 class="fw-bold mb-0">Thông tin khách hàng</h6>
			</div>
			<div class="card-body">
				<div class="d-flex align-items-center mb-3">
					<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
						@Model.Customer?.FullName?.Substring(0, 1)
					</div>
					<div>
						<h6 class="fw-bold mb-0">@Model.Customer?.FullName</h6>
						<span class="badge bg-light text-dark border">@Model.Customer?.CustomerLevel</span>
					</div>
				</div>
				<hr class="my-3">
				<div class="mb-2">
					<small class="text-muted d-block">Email</small>
					<span>@(Model.Customer?.Email ?? "N/A")</span>
				</div>
				<div class="mb-2">
					<small class="text-muted d-block">Số điện thoại</small>
					<span>@(Model.Customer?.PhoneNumber ?? "N/A")</span>
				</div>
				<div class="mb-2">
					<small class="text-muted d-block">Ghi chú</small>
					<p class="small text-muted mb-0">@(Model.Customer?.Note ?? "Không có ghi chú")</p>
				</div>
			</div>
		</div>

		<!-- Payment Info -->
		<div class="card border-0 shadow-sm" style="border-radius: 12px;">
			<div class="card-header bg-white border-0 py-3">
				<h6 class="fw-bold mb-0">Thông tin thanh toán</h6>
			</div>
			<div class="card-body">
				<div class="d-flex justify-content-between mb-2">
					<span class="text-muted">Phương thức</span>
					<span class="fw-bold">@Model.PaymentMethod</span>
				</div>
				<div class="d-flex justify-content-between mb-2">
					<span class="text-muted">Trạng thái</span>
					@{
						var paymentClass = Model.PaymentStatus == "Paid" ? "text-success" : "text-warning";
					}
					<span class="@paymentClass fw-bold">@Model.PaymentStatus</span>
				</div>
				<div class="alert alert-light border mt-3 mb-0 small">
					<i class="bi bi-info-circle me-1"></i> Địa chỉ giao hàng:<br>
					<strong>@Model.ShippingAddress</strong>
				</div>
			</div>
		</div>
	</div>
</div>
