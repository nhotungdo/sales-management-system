@model Sales_Management.Areas.Admin.ViewModels.FinancialReportViewModel
@{
    ViewData["Title"] = "Báo cáo Tài chính";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-dark mb-0">Báo cáo & Phân tích</h3>
    <!-- Future: Add Export Financials Button -->
</div>

<partial name="_ReportTabs" />

<!-- Filters -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-3">
        <form method="get" class="row g-3 align-items-center">
            <!-- Simplified Date Range Display -->
            <div class="col-auto">
                <span class="text-muted">Kỳ báo cáo: </span>
                <span class="fw-bold">@Model.StartDate.ToString("dd/MM/yyyy") - @Model.EndDate.ToString("dd/MM/yyyy")</span>
            </div>
        </form>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 py-2 border-left-success">
            <div class="card-body">
                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Tổng thu (Ví điện tử)</div>
                <div class="h3 mb-0 fw-bold text-gray-800">@Model.TotalCashIn.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
         <div class="card border-0 shadow-sm h-100 py-2 border-left-danger">
            <div class="card-body">
                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Tổng chi (Ví điện tử)</div>
                <div class="h3 mb-0 fw-bold text-gray-800">@Model.TotalCashOut.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</div>
            </div>
        </div>
    </div>
     <div class="col-md-4">
         <div class="card border-0 shadow-sm h-100 py-2 border-left-primary">
            <div class="card-body">
                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Doanh thu thực (Đã thanh toán)</div>
                <div class="h3 mb-0 fw-bold text-gray-800">@Model.NetRevenue.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
     <div class="col-lg-8">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 fw-bold text-primary">Dòng tiền (Theo ngày)</h6>
            </div>
            <div class="card-body">
                 <div class="chart-area" style="height: 350px;">
                    <canvas id="cashFlowChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 fw-bold text-dark">Trạng thái Hóa đơn</h6>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    @foreach(var item in Model.InvoiceStats)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span>
                                @if(item.Status == "Paid") { <i class="bi bi-check-circle-fill text-success me-2"></i> }
                                else if(item.Status == "Pending") { <i class="bi bi-clock-fill text-warning me-2"></i> }
                                else { <i class="bi bi-x-circle-fill text-danger me-2"></i> }
                                @(item.Status == "Paid" ? "Đã thanh toán" : (item.Status == "Pending" ? "Chờ thanh toán" : "Hoàn tiền/Hủy"))
                            </span>
                             <div class="text-end">
                                <span class="d-block fw-bold">@item.TotalAmount.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</span>
                                <small class="text-muted">@item.Count đơn</small>
                            </div>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var ctx = document.getElementById("cashFlowChart");
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.ChartLabels)),
                datasets: [{
                    label: "Tiền vào",
                    data: @Html.Raw(Json.Serialize(Model.CashInChartData)),
                    backgroundColor: "#1cc88a",
                    hoverBackgroundColor: "#17a673",
                },
                {
                    label: "Tiền ra",
                    data: @Html.Raw(Json.Serialize(Model.CashOutChartData)),
                    backgroundColor: "#e74a3b",
                    hoverBackgroundColor: "#be2617",
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        ticks: {
                            callback: function(value) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumSignificantDigits: 3 }).format(value); }
                        },
                        grid: { color: "rgb(234, 236, 244)", borderDash: [2], drawBorder: false, zeroLineColor: "rgb(234, 236, 244)" }
                    }
                },
                plugins: {
                    tooltip: {
                         callbacks: {
                             label: function(context) {
                                var label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed.y);
                                return label;
                            }
                         }
                    }
                }
            }
        });
    </script>
}
